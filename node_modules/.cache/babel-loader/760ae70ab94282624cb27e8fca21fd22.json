{"ast":null,"code":"import { createSlice } from \"@reduxjs/toolkit\";\nimport { clamp } from \"portal/scenes/CoursePlayer/utilities/clamp\";\nimport { InteractionModes, Defaults, FullscreenState } from \"portal/scenes/CoursePlayer/constants\";\nimport { buildClipProgress } from \"portal/scenes/CoursePlayer/utilities/sync-clip-progress\";\nimport { calculateAspectRatio } from \"portal/scenes/CoursePlayer/utilities/aspect-ratio\";\nimport { findBreakpoint } from \"portal/scenes/CoursePlayer/utilities/find-breakpoint\";\nconst validModes = Object.values(InteractionModes);\n\nfunction includes(modes, mode) {\n  return !!~modes.indexOf(mode);\n}\n\nexport const initialState = {\n  playing: false,\n  playbackSpeed: 1.0,\n  activeMenu: null,\n  volumeSliderActive: false,\n  volume: 0.5,\n  muted: false,\n  previousVolume: null,\n  interactionMode: InteractionModes.MOUSE,\n  time: 0,\n  duration: 0,\n  bufferedTime: 0,\n  playheadStart: 0,\n  overlay: null,\n  videoPlayer: null,\n  seekedEvent: null,\n  seekingEvent: null,\n  visible: false,\n  fullscreenState: FullscreenState.NORMAL,\n  clipProgress: 0,\n  buffering: false,\n  containerSize: null,\n  breakpoint: null,\n  playerSize: null,\n  layout: null,\n  loading: false\n};\nexport const playerSlice = createSlice({\n  name: \"player\",\n  initialState,\n  reducers: {\n    play: (state, action) => {\n      const icon = \"PLAY\";\n\n      if (action.payload) {\n        state.overlay = {\n          icon,\n          key: Math.random(),\n          fade: true\n        };\n      }\n\n      state.playing = true;\n      state.playheadStart = state.time;\n    },\n    pause: (state, action) => {\n      const icon = \"PAUSE\";\n\n      if (action.payload) {\n        state.overlay = {\n          icon,\n          key: Math.random(),\n          fade: true\n        };\n      }\n\n      state.playing = false;\n      state.playheadStart = state.time;\n    },\n    setPlaybackSpeed: (state, action) => {\n      state.playbackSpeed = action.payload;\n    },\n    setActiveMenu: (state, action) => {\n      state.activeMenu = action.payload;\n    },\n    setVolumeSliderActive: (state, action) => {\n      state.volumeSliderActive = action.payload;\n    },\n    setVolume: (state, action) => {\n      const clamped = clamp(action.payload, 0, 1);\n      const muted = clamped === 0;\n      state.volume = clamped;\n      state.muted = muted;\n    },\n    setPreviousVolume: (state, action) => {\n      const clamped = clamp(action.payload, 0, 1);\n      const muted = clamped === 0;\n      state.volume = clamped;\n      state.muted = muted;\n    },\n    setInteractionMode: (state, action) => {\n      if (!includes(validModes, action.payload)) {\n        throw new Error(`${action.payload} not in valid list: ${validModes.join()}`);\n      }\n\n      state.interactionMode = action.payload;\n    },\n    showUI: (state, action) => {\n      state.visible = true;\n    },\n    toggleFullscreen: (state, action) => {\n      state.fullscreenState = state.fullscreenState === FullscreenState.FULLSCREEN ? FullscreenState.NORMAL : FullscreenState.FULLSCREEN;\n    },\n    hideUI: (state, action) => {\n      state.visible = false;\n    },\n    setDuration: (state, action) => {\n      state.duration = action.payload;\n    },\n    setTime: (state, action) => {\n      state.time = action.payload;\n    },\n    setContainerSize: (state, action) => {\n      var containerSize = action.payload;\n\n      if (containerSize.width === 0 && containerSize.height === 0 && state.containerSize) {\n        containerSize = state.containerSize;\n      }\n\n      state.breakpoint = findBreakpoint(containerSize);\n      state.playerSize = calculateAspectRatio(containerSize);\n      state.containerSize = containerSize;\n      state.layout = `${state.breakpoint.height}p`;\n    },\n    setBufferedTime: (state, action) => {\n      state.bufferedTime = action.payload;\n    },\n    ready: (state, action) => {\n      state.playheadStart = state.time;\n      state.duration = action.payload;\n    },\n    registerPlayer: (state, action) => {\n      state.seekedEvent = new Event(\"ps-seeked\");\n      state.seekingEvent = new Event(\"ps-seeking\");\n      state.videoPlayer = action.payload;\n    },\n    seekStart: (state, action) => {\n      const {\n        seekingEvent,\n        videoPlayer\n      } = state;\n      videoPlayer && videoPlayer.dispatchEvent(seekingEvent);\n    },\n    seekEnd: (state, action) => {\n      const {\n        seekedEvent,\n        videoPlayer\n      } = state;\n      videoPlayer && videoPlayer.dispatchEvent(seekedEvent);\n    },\n    seek: (state, action) => {\n      state.playheadStart = action.payload * state.duration;\n    },\n    setOverlay: (state, action) => {\n      state.overlay = action.payload;\n    },\n    setBuffering: (state, action) => {\n      state.buffering = action.payload;\n    },\n    setLoading: (state, action) => {\n      state.buffering = action.payload;\n    },\n    setClipProgress: (state, action) => {\n      state.clipProgress = buildClipProgress(state.clipProgress, action.payload, state.duration);\n    },\n    setFullscreen: (state, action) => {\n      const validFullscreenStates = Object.values(FullscreenState);\n\n      if (!includes(validFullscreenStates, action.payload)) {\n        throw new Error(`${action.payload} not in valid list: ${validFullscreenStates.join()}`);\n      }\n\n      state.fullscreenState = action.payload;\n    },\n    fastForward: (state, action) => {\n      const {\n        time,\n        duration\n      } = state;\n      const forwardTime = time + 10;\n      const newTime = forwardTime > duration ? duration : forwardTime;\n      state.playheadStart = newTime;\n      state.time = newTime;\n      state.overlay = {\n        icon: \"FWD\",\n        key: Math.random(),\n        fade: true\n      };\n    },\n    fastRewind: (state, action) => {\n      const {\n        time,\n        duration\n      } = state;\n      const startTime = 0;\n      const rewindTime = time - 10;\n      const newTime = rewindTime < startTime ? startTime : rewindTime;\n      state.playheadStart = newTime;\n      state.time = newTime;\n      state.overlay = {\n        icon: \"BACK\",\n        key: Math.random(),\n        fade: true\n      };\n    },\n    toggleMute: (state, action) => {\n      if (state.muted) {\n        const clamped = state.previousVolume || Defaults.volume;\n        const muted = clamped === 0;\n        state.volume = clamped;\n        state.muted = muted;\n      } else {\n        state.muted = true;\n        state.previousVolume = state.volume;\n        state.volume = 0;\n      }\n    }\n  }\n});\nexport const selectPlayer = state => state.player;\nexport const {\n  play,\n  pause,\n  setPlaybackSpeed,\n  setActiveMenu,\n  setVolumeSliderActive,\n  setVolume,\n  setPreviousVolume,\n  toggleMute,\n  setDuration,\n  setTime,\n  ready,\n  fastForward,\n  fastRewind,\n  seekEnd,\n  seekStart,\n  registerPlayer,\n  showUI,\n  hideUI,\n  setInteractionMode,\n  toggleFullscreen,\n  setFullscreen,\n  seek,\n  setBufferedTime,\n  setBuffering,\n  setClipProgress,\n  setOverlay,\n  setContainerSize\n} = playerSlice.actions;\nexport const togglePlayPause = () => (dispatch, getState) => {\n  const state = getState().player;\n\n  if (state.playing) {\n    dispatch(pause());\n  } else {\n    dispatch(play());\n  }\n};\nexport default playerSlice.reducer;","map":{"version":3,"sources":["/Users/akrah/Documents/dev/readux/src/codefluent/src/state/player/playerSlice.ts"],"names":["createSlice","clamp","InteractionModes","Defaults","FullscreenState","buildClipProgress","calculateAspectRatio","findBreakpoint","validModes","Object","values","includes","modes","mode","indexOf","initialState","playing","playbackSpeed","activeMenu","volumeSliderActive","volume","muted","previousVolume","interactionMode","MOUSE","time","duration","bufferedTime","playheadStart","overlay","videoPlayer","seekedEvent","seekingEvent","visible","fullscreenState","NORMAL","clipProgress","buffering","containerSize","breakpoint","playerSize","layout","loading","playerSlice","name","reducers","play","state","action","icon","payload","key","Math","random","fade","pause","setPlaybackSpeed","setActiveMenu","setVolumeSliderActive","setVolume","clamped","setPreviousVolume","setInteractionMode","Error","join","showUI","toggleFullscreen","FULLSCREEN","hideUI","setDuration","setTime","setContainerSize","width","height","setBufferedTime","ready","registerPlayer","Event","seekStart","dispatchEvent","seekEnd","seek","setOverlay","setBuffering","setLoading","setClipProgress","setFullscreen","validFullscreenStates","fastForward","forwardTime","newTime","fastRewind","startTime","rewindTime","toggleMute","selectPlayer","player","actions","togglePlayPause","dispatch","getState","reducer"],"mappings":"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","sourcesContent":["import { createAsyncThunk, createSlice, PayloadAction } from \"@reduxjs/toolkit\";\nimport { v1 as uuid } from \"uuid\";\nimport { StringChain, stubFalse, without } from \"lodash\";\nimport { AppThunk, RootState } from \"store\";\nimport { clamp } from \"portal/scenes/CoursePlayer/utilities/clamp\";\nimport {\n  InteractionModes,\n  Defaults,\n  FullscreenState,\n} from \"portal/scenes/CoursePlayer/constants\";\nimport { buildClipProgress } from \"portal/scenes/CoursePlayer/utilities/sync-clip-progress\";\nimport { calculateAspectRatio } from \"portal/scenes/CoursePlayer/utilities/aspect-ratio\";\nimport { findBreakpoint } from \"portal/scenes/CoursePlayer/utilities/find-breakpoint\";\n\nconst validModes = Object.values(InteractionModes);\n\nfunction includes(modes, mode) {\n  return !!~modes.indexOf(mode);\n}\n\nexport interface PlayerState {\n  playing: boolean;\n  playbackSpeed: number;\n  activeMenu: string;\n  volumeSliderActive: boolean;\n  volume: number;\n  muted: boolean;\n  previousVolume: number;\n  interactionMode: string;\n  time: number;\n  bufferedTime: number;\n  duration: number;\n  playheadStart: number;\n  overlay: Overlay;\n  videoPlayer: any;\n  seekedEvent: Event;\n  seekingEvent: Event;\n  visible: boolean;\n  fullscreenState: string;\n  clipProgress: number;\n  buffering: boolean;\n  containerSize: ContainerSize;\n  breakpoint: ContainerSize;\n  playerSize: ContainerSize;\n  layout: string;\n  loading: boolean;\n  autoplay: boolean;\n}\n\nexport interface Overlay {\n  icon: string;\n  key: number;\n  fade: boolean;\n}\n\ninterface ContainerSize {\n  width: number;\n  height: number;\n}\n\nexport const initialState: PlayerState = {\n  playing: false,\n  playbackSpeed: 1.0,\n  activeMenu: null,\n  volumeSliderActive: false,\n  volume: 0.5,\n  muted: false,\n  previousVolume: null,\n  interactionMode: InteractionModes.MOUSE,\n  time: 0,\n  duration: 0,\n  bufferedTime: 0,\n  playheadStart: 0,\n  overlay: null,\n  videoPlayer: null,\n  seekedEvent: null,\n  seekingEvent: null,\n  visible: false,\n  fullscreenState: FullscreenState.NORMAL,\n  clipProgress: 0,\n  buffering: false,\n  containerSize: null,\n  breakpoint: null,\n  playerSize: null,\n  layout: null,\n  loading: false,\n  \n};\nexport const playerSlice = createSlice({\n  name: \"player\",\n  initialState,\n  reducers: {\n    play: (state, action: PayloadAction<boolean>) => {\n      const icon = \"PLAY\";\n\n      if (action.payload) {\n        state.overlay = { icon, key: Math.random(), fade: true };\n      }\n      state.playing = true;\n      state.playheadStart = state.time;\n    },\n\n    pause: (state, action: PayloadAction<boolean>) => {\n      const icon = \"PAUSE\";\n\n      if (action.payload) {\n        state.overlay = { icon, key: Math.random(), fade: true };\n      }\n      state.playing = false;\n      state.playheadStart = state.time;\n    },\n\n    setPlaybackSpeed: (state, action: PayloadAction<number>) => {\n      state.playbackSpeed = action.payload;\n    },\n\n    setActiveMenu: (state, action: PayloadAction<string>) => {\n      state.activeMenu = action.payload;\n    },\n    setVolumeSliderActive: (state, action: PayloadAction<boolean>) => {\n      state.volumeSliderActive = action.payload;\n    },\n    setVolume: (state, action: PayloadAction<number>) => {\n      const clamped = clamp(action.payload, 0, 1);\n      const muted = clamped === 0;\n      state.volume = clamped;\n      state.muted = muted;\n    },\n    setPreviousVolume: (state, action: PayloadAction<number>) => {\n      const clamped = clamp(action.payload, 0, 1);\n      const muted = clamped === 0;\n      state.volume = clamped;\n      state.muted = muted;\n    },\n    setInteractionMode: (state, action: PayloadAction<string>) => {\n      if (!includes(validModes, action.payload)) {\n        throw new Error(\n          `${action.payload} not in valid list: ${validModes.join()}`\n        );\n      }\n      state.interactionMode = action.payload;\n    },\n\n    showUI: (state, action: PayloadAction<void>) => {\n      state.visible = true;\n    },\n\n    toggleFullscreen: (state, action: PayloadAction<void>) => {\n      state.fullscreenState =\n        state.fullscreenState === FullscreenState.FULLSCREEN\n          ? FullscreenState.NORMAL\n          : FullscreenState.FULLSCREEN;\n    },\n\n    hideUI: (state, action: PayloadAction<void>) => {\n      state.visible = false;\n    },\n\n    setDuration: (state, action: PayloadAction<number>) => {\n      state.duration = action.payload;\n    },\n    setTime: (state, action: PayloadAction<number>) => {\n      state.time = action.payload;\n    },\n\n    setContainerSize: (state, action: PayloadAction<ContainerSize>) => {\n      var containerSize = action.payload;\n      if (\n        containerSize.width === 0 &&\n        containerSize.height === 0 &&\n        state.containerSize\n      ) {\n        containerSize = state.containerSize;\n      }\n\n      state.breakpoint = findBreakpoint(containerSize);\n      state.playerSize = calculateAspectRatio(containerSize);\n      state.containerSize = containerSize;\n      state.layout = `${state.breakpoint.height}p`;\n    },\n\n    setBufferedTime: (state, action: PayloadAction<number>) => {\n      state.bufferedTime = action.payload;\n    },\n\n    ready: (state, action: PayloadAction<number>) => {\n      state.playheadStart = state.time;\n      state.duration = action.payload;\n    },\n    registerPlayer: (state, action: PayloadAction<HTMLVideoElement>) => {\n      state.seekedEvent = new Event(\"ps-seeked\");\n      state.seekingEvent = new Event(\"ps-seeking\");\n      state.videoPlayer = action.payload;\n    },\n\n    seekStart: (state, action: PayloadAction<void>) => {\n      const { seekingEvent, videoPlayer } = state;\n\n      videoPlayer && videoPlayer.dispatchEvent(seekingEvent);\n    },\n\n    seekEnd: (state, action: PayloadAction<void>) => {\n      const { seekedEvent, videoPlayer } = state;\n\n      videoPlayer && videoPlayer.dispatchEvent(seekedEvent);\n    },\n\n    seek: (state, action: PayloadAction<number>) => {\n      state.playheadStart = action.payload * state.duration;\n    },\n\n    setOverlay: (state, action: PayloadAction<Overlay>) => {\n      state.overlay = action.payload;\n    },\n\n    setBuffering: (state, action: PayloadAction<boolean>) => {\n      state.buffering = action.payload;\n    },\n\n    setLoading: (state, action: PayloadAction<boolean>) => {\n        state.buffering = action.payload;\n    },\n\n    setClipProgress: (state, action: PayloadAction<number>) => {\n      state.clipProgress = buildClipProgress(\n        state.clipProgress,\n        action.payload,\n        state.duration\n      );\n    },\n\n    setFullscreen: (state, action: PayloadAction<string>) => {\n      const validFullscreenStates = Object.values(FullscreenState);\n\n      if (!includes(validFullscreenStates, action.payload)) {\n        throw new Error(\n          `${action.payload} not in valid list: ${validFullscreenStates.join()}`\n        );\n      }\n      state.fullscreenState = action.payload;\n    },\n\n    fastForward: (state, action: PayloadAction<void>) => {\n      const { time, duration } = state;\n\n      const forwardTime = time + 10;\n\n      const newTime = forwardTime > duration ? duration : forwardTime;\n      state.playheadStart = newTime;\n      state.time = newTime;\n      state.overlay = {\n        icon: \"FWD\",\n        key: Math.random(),\n        fade: true,\n      };\n    },\n\n    fastRewind: (state, action: PayloadAction<void>) => {\n      const { time, duration } = state;\n\n      const startTime = 0;\n      const rewindTime = time - 10;\n\n      const newTime = rewindTime < startTime ? startTime : rewindTime;\n      state.playheadStart = newTime;\n      state.time = newTime;\n      state.overlay = {\n        icon: \"BACK\",\n        key: Math.random(),\n        fade: true,\n      };\n    },\n\n    toggleMute: (state, action: PayloadAction<void>) => {\n      if (state.muted) {\n        const clamped = state.previousVolume || Defaults.volume;\n        const muted = clamped === 0;\n        state.volume = clamped;\n        state.muted = muted;\n      } else {\n        state.muted = true;\n        state.previousVolume = state.volume;\n        state.volume = 0;\n      }\n    },\n  },\n});\n\nexport const selectPlayer = (state: RootState) => state.player;\n\nexport const {\n  play,\n  pause,\n  setPlaybackSpeed,\n  setActiveMenu,\n  setVolumeSliderActive,\n  setVolume,\n  setPreviousVolume,\n  toggleMute,\n  setDuration,\n  setTime,\n  ready,\n  fastForward,\n  fastRewind,\n  seekEnd,\n  seekStart,\n  registerPlayer,\n  showUI,\n  hideUI,\n  setInteractionMode,\n  toggleFullscreen,\n  setFullscreen,\n  seek,\n  setBufferedTime,\n  setBuffering,\n  setClipProgress,\n  setOverlay,\n  setContainerSize,\n} = playerSlice.actions;\n\nexport const togglePlayPause = (): AppThunk => (dispatch, getState) => {\n  const state = getState().player;\n  if (state.playing) {\n    dispatch(pause());\n  } else {\n    dispatch(play());\n  }\n};\n\nexport default playerSlice.reducer;\n"]},"metadata":{},"sourceType":"module"}